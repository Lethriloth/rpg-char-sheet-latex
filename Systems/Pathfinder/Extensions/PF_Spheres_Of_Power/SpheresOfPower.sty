\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{SpheresOfPower}[2016/12/14 Alternate magic system for Pathfinder]


\edef\charSpheresList{}
\newCounter{charCLCount}
\newCounter{charSpheresSaveDCCount}
\setCounter{charSpheresSaveDCCount}{10}
\newCounter{charSpellPointsCount}
\newCounter{charMSBCount}
\setCounter{charMSBCount}{0}
\newCounter{charMSDCount}
\setCounter{charMSDCount}{11}
\newcommand{\charCastingAbility}{Int}
\newCounter{charCastingModCount}
\newCounter{HalfCL}
\newcommand{\HalfCLMinOne}{\ifnum\value{HalfCL} > 1 \arabic{HalfCL}\else1\fi{}}
\newcommand{\CLMinTwo}{\ifnum \value{charCLCount} > 2 \arabic{charCLCount}\else2\fi}
\newcommand{\setCastingAbility}[1]{
	\renewcommand{\charCastingAbility}{#1}
}

\newcommand{\s}[1][charCLCount]{\ifnum\value{#1}=1\else s\fi}

\newcommand{\setCharCastingAbility}[1]{
	\def\charCastingAbility{#1}
}

\newCounter{charSpareMagicTalentsCount}

\DeclareDocumentCommand{\addSphere}{s O{0}mo}{
	\IfBooleanF #1 {\addtocounter{charSpareMagicTalentsCount}{-1}}
	\newCounter{char#3SaveDCModCount}
	\newCounter{char#3CLModCount}
	\setCounter{char#3CLModCount}{#2}
	\listinsert{\charSpheresList}{#3}
	\input{./Data/Spheres/#3}
	\IfNoValueF{#4}{\csname Sphere#3executable\endcsname{#4}}
}

\DeclareDocumentCommand{\addTalent}{s O{1}mmo}{
	\IfBooleanF #1 {\addtocounter{charSpareMagicTalentsCount}{-#2}}
	\expandafter\listinsert\csname char#3TalentsList\endcsname{#4}
	\ifthenelse{\equal{#2}{1}\OR\equal{#2}{}}{\expandafter\def\csname charTalent#4Count\endcsname{}}{\expandafter\def\csname charTalent#4Count\endcsname{(#2)}}
	\csname Talent#4Executable\endcsname{#2}{#5}
}


\newcommand{\defineSphere}[3]{
	\expandafter\edef\csname char#1TalentsList\endcsname{}
	\expandafter\edef\csname char#1BaseAbilitiesList\endcsname{}
	\expandafter\def\csname Sphere#1ShortDescription\endcsname{#2}
	\expandafter\def\csname Sphere#1FullDescription\endcsname{#3}
}

\newcommand{\defineBaseAbility}[4]{
	\expandafter\def\csname charBaseAbility#2ShortDescription\endcsname{#3}
	\expandafter\def\csname charBaseAbility#2FullDescription\endcsname{#4}
	\expandafter\listadd\csname char#1BaseAbilitiesList\endcsname{#2}
}

\newcommand{\defineTalent}[4]{
	\expandafter\def\csname charTalent#1ShortDescription\endcsname{#2}
	\expandafter\def\csname charTalent#1FullDescription\endcsname{#3}
	\expandafter\NewDocumentCommand\csname Talent#1Executable\endcsname{mm}{#4}
}


\newcommand{\PrintSphereInTable}[1]{
	\begin{wrapfigure}[1]{l}{1\unitlength}%
		\vspace{-24pt}\includegraphics[scale=0.2]{./Data/Spheres/#1.png}%
	\end{wrapfigure}
		 & 
	\addToCounter{char#1SaveDCModCount}{(\value{char#1CLModCount} + \value{charCLCount}) / 2 - (\value{charCLCount} / 2)}
	\sc{\vfill\large\textbf{#1%
	\ifthenelse{\value{char#1CLModCount} = 0}{%
		\ifthenelse{\value{char#1SaveDCModCount} = 0}{}{%
			\\(DC \domath{\value{char#1SaveDCModCount} + \value{charSpheresSaveDCCount}})%
		}%
	}{%
		\\(CL \domath{\value{char#1CLModCount}+\value{charCLCount}}%
		\ifthenelse{\value{char#1SaveDCModCount} = 0}{}{%
			; DC \domath{\value{char#1SaveDCModCount} + \value{charSpheresSaveDCCount}}%
		})%
	}}}& \vfill\csname Sphere#1ShortDescription\endcsname \tabularnewline
	\addToCounter{charCLCount}{\value{char#1CLModCount}}
	\setCounter{HalfCL}{\value{charCLCount} / 2}
	\ifthenelse{\value{charCLCount} = 0}{
		\addToCounter{charCLCount}{1}
		\forlistcsloop{\PrintSphereBaseAbilityInTable}{char#1BaseAbilitiesList}
		\forlistcsloop{\PrintSphereTalentInTable}{char#1TalentsList}
		\addToCounter{charCLCount}{-1}
	}{
		\forlistcsloop{\PrintSphereBaseAbilityInTable}{char#1BaseAbilitiesList}
		\forlistcsloop{\PrintSphereTalentInTable}{char#1TalentsList}
	}
	\addToCounter{charCLCount}{-\value{char#1CLModCount}}
	\setCounter{HalfCL}{\value{charCLCount} / 2}
}

\newcommand{\PrintSphere}[1]{
	\huge
	\begin{wrapfigure}[13]{l}{150pt}
		\includegraphics{./Data/Spheres/#1.png}
	\end{wrapfigure} \noindent #1\normalsize\\
	\csname Sphere#1FullDescription\endcsname\par
	\forlistcsloop{\PrintSphereBaseAbility}{char#1BaseAbilitiesList}
	\forlistcsloop{\PrintSphereTalent}{char#1TalentsList}
	\newpage
}

\newcommand{\PrintSphereBaseAbilityInTable}[1]{
	& \textit{#1} & \csname charBaseAbility#1ShortDescription\endcsname \tabularnewline
}
\newcommand{\PrintSphereBaseAbility}[1]{
\textbf{\textit{#1:}} \csname charBaseAbility#1FullDescription\endcsname \par
}
\newcommand{\PrintSphereTalentInTable}[1]{
	& \textbf{#1 \csname charTalent#1Count\endcsname} & \csname charTalent#1ShortDescription\endcsname \tabularnewline
}
\newcommand{\PrintSphereTalent}[1]{
	
	\textbf{\\\large #1\\}\csname charTalent#1FullDescription\endcsname
}

\edef\charSpheresCastingNotesList{}
\newcommand{\addSpheresCastingNote}[1]{
	\listadd{\charSpheresCastingNotesList}{#1}
}
\newCounter{charTotalSpheresClassCount}
\DeclareDocumentCommand{\ImportSpheresClass}{s O{} m O{} m}{
	\if\csname#3CL\endcsname g
		\addToCounter{charCLCount}{#5}
		\addToCounter{charMSBCount}{#5}
		\addToCounter{charMSDCount}{#5}
		\addToCounter{charSpellPointsCount}{#5}
	\fi
	\if\csname#3CL\endcsname a
		\addToCounter{charCLCount}{#5 * 3 / 4}
		\addToCounter{charMSBCount}{#5}
		\addToCounter{charMSDCount}{#5}
		\addToCounter{charSpellPointsCount}{#5}
	\fi
	\if\csname#3CL\endcsname p
		\addToCounter{charCLCount}{#5 / 2}
		\addToCounter{charMSBCount}{#5}
		\addToCounter{charMSDCount}{#5}
		\addToCounter{charSpellPointsCount}{#5}
	\fi
	\if\csname#3CL\endcsname {p3}
	\ifthenelse{#5 > 3}{
		\addToCounter{charCLCount}{(#5 - 3) / 2}
		\addToCounter{charMSBCount}{#5 - 3}
		\addToCounter{charMSDCount}{#5 - 3}
		\addToCounter{charSpellPointsCount}{#5 - 3}}{}
	\fi
	\addToCounter{charTotalSpheresClassCount}{#5}
	\IfBooleanTF #1 {
		\ImportCharClass*[#2]{#3}[#4]{#5}
	}{
		\ImportCharClass[#2]{#3}[#4]{#5}
	}
}
\edef\charCastingTraditionDescription{}
\newcounter{charNetCastingTraditionDrawbacks}
\DeclareDocumentCommand{\addCastingTradition}{m m o m}{%
	\def\charCastingTraditionDescription{%
		\textbf{Casting Tradition: #1}
		- \textit{\PrintCSVList{#2}\IfValueT{#3}{, \PrintCSVList{#3}}}
		\ifthenelse{\equal{#4}{}}{}{$\bullet$ \textit{\PrintCSVList{#4}}}%
	}
	\renewcommand{\do}[1]{\stepcounter{charNetCastingTraditionDrawbacks}}
	\docsvlist{#2}
	\renewcommand{\do}[1]{\addToCounter{charNetCastingTraditionDrawbacks}{-2}}
	\docsvlist{#4}
	\IfValueT{#3}{%
		\renewcommand{\do}[1]{\stepcounter{charSpareMagicTalentsCount}}
		\docsvlist{#3}
	}
	\addtocounter{charSpareMagicTalentsCount}{2}
}

\newcommand{\InitializeSpheres}{
	\setCounter{charCastingModCount}{\value{char\charCastingAbility ModCount}}
	\setCounter{HalfCL}{\value{charCLCount} / 2}
	\addToCounter{charSpheresSaveDCCount}{\value{HalfCL}}
	\addToCounter{charSpheresSaveDCCount}{\value{charCastingModCount}}
	\addToCounter{charSpellPointsCount}{\value{charCastingModCount}}
	\ifthenelse{\value{charNetCastingTraditionDrawbacks} = 1}{
		\addtocounter{charSpellPointsCount}{1 + \value{charTotalSpheresClassCount} / 6}
	}{
	\ifthenelse{\value{charNetCastingTraditionDrawbacks} = 2}{
		\addtocounter{charSpellPointsCount}{1 + \value{charTotalSpheresClassCount} / 3}
	}{
	\ifthenelse{\value{charNetCastingTraditionDrawbacks} = 3}{
		\addtocounter{charSpellPointsCount}{(1 + \value{charTotalSpheresClassCount}) / 2}
	}{
	\ifthenelse{\value{charNetCastingTraditionDrawbacks} = 4}{
		\addtocounter{charSpellPointsCount}{1 + \value{charTotalSpheresClassCount} * 2 / 3}
	}{
	\ifthenelse{\value{charNetCastingTraditionDrawbacks} > 4}{
		\addtocounter{charSpellPointsCount}{\value{charTotalSpheresClassCount}}
	}{}}}}}
}
\appto{\Initialize}{
	\InitializeSpheres
}

\newcommand{\SpheresChecks}{
	%%Check number of magic talents
	\ifthenelse{\value{charSpareMagicTalentsCount} > 0}{
		\addnotice{Choose \arabic{charSpareMagicTalentsCount} more magic talents.}
	}{\ifthenelse{\value{charSpareMagicTalentsCount} < 0}{
		\addnotice{\domath{-\value{charSpareMagicTalentsCount}} too many magic talents chosen.}
	}{}}
	%%Check that player has enough casting tradition drawbacks to cover boons
	\ifthenelse{\value{charNetCastingTraditionDrawbacks} < 0}{
		\addnotice{Too many casting tradition boons. Remove \domath{(-\value{charNetCastingTraditionDrawbacks} + 1) / 2} boons or add \domath{-\value{charNetCastingTraditionDrawbacks}} more drawbacks.}
	}{}
}
\appto{\RunChecks}{
	\SpheresChecks
}