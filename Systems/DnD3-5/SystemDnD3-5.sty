\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{SystemDnD3-5}[2016/12/29 D\&D 3.5e system-specific features for rpgcharsheet2.cls]
\RequirePackage{Systems/D20-Common/SystemD20-Common}

%%%% Character Attributes %%%%

%% BAB, attacks, combat maneuvers
\renewcommand{\do}[1]{
	\NewCounter{Char#1MiscCount}
	\NewCounter{Char#1TmpCount}
}\docsvlist{Melee,Ranged,Grapple,BullRush,Disarm,Overrun,Sunder,Trip}



%% Size
\NewCounter{CharSpecialSizeModCount}
\newcommand\SetSize[1]{
	\csname SetSize#1\endcsname
}
\newcommand\SetSizeFine{
	\renewcommand{\CharSize}{Fine}
	\SetCounter{CharSizeModCount}{8}
	\SetCounter{CharSpecialSizeModCount}{-16}
}
\newcommand\SetSizeDiminutive{
	\renewcommand{\CharSize}{Diminutive}
	\SetCounter{CharSizeModCount}{4}
	\SetCounter{CharSpecialSizeModCount}{-12}
}
\newcommand\SetSizeTiny{
	\renewcommand{\CharSize}{Tiny}
	\SetCounter{CharSizeModCount}{2}
	\SetCounter{CharSpecialSizeModCount}{-8}
}
\newcommand\SetSizeSmall{
	\renewcommand{\CharSize}{Small}
	\SetCounter{CharSizeModCount}{1}
	\SetCounter{CharSpecialSizeModCount}{-4}
}
\newcommand\SetSizeMedium{
	\renewcommand{\CharSize}{Medium}
	\SetCounter{CharSizeModCount}{0}
	\SetCounter{CharSpecialSizeModCount}{0}
}
\newcommand\SetSizeLarge{
	\renewcommand{\CharSize}{Large}
	\SetCounter{CharSizeModCount}{-1}
	\SetCounter{CharSpecialSizeModCount}{4}
}
\newcommand\SetSizeHuge{
	\renewcommand{\CharSize}{Huge}
	\SetCounter{CharSizeModCount}{-2}
	\SetCounter{CharSpecialSizeModCount}{8}
}
\newcommand\SetSizeGargantuan{
	\renewcommand{\CharSize}{Gargantuan}
	\SetCounter{CharSizeModCount}{-4}
	\SetCounter{CharSpecialSizeModCount}{12}
}
\newcommand\SetSizeColossal{
	\renewcommand{\CharSize}{Colossal}
	\SetCounter{CharSizeModCount}{-8}
	\SetCounter{CharSpecialSizeModCount}{16}
}

%% Speed
\newcommand{\CharManeuverability}{}
\newcommand{\AddFlySpeed}[2]{
	\SetCounter{CharFlySpeedCount}{#1}
	\renewcommand{\CharManeuverability}{#2}
}


%%%% Feats, Class & Race Features %%%%

%% Class Importing %%
\NewDocumentCommand{\ImportCharClass}{s O{} m m}{
	\AddDebug{IMPORTCHARCLASS: add #4 Levels of #3}
	\input{"\datafolder/Classes/#3.tex"}

	\newcounter{Char#3SpareSkillRanksCount}
	\ifthenelse{\value{CharTotalLevelCount} = 0}{
		\SetCounter{Char#3SpareSkillRanksCount}{(\value{CharBonusSkillRanksPerLevelCount}+\value{#3SkillRanksPerLevelCount}) * (3 + #4)}
	}{
		\SetCounter{Char#3SpareSkillRanksCount}{(\value{CharBonusSkillRanksPerLevelCount}+\value{#3SkillRanksPerLevelCount}) * #4}
	}

	\ImportCharClassCommon{#3}{#4}

	\ifthenelse{\equal{#2}{}}{
		\appto\CharLevel{\capitalize{#3} #4 }
	}{
		\appto\CharLevel{#2 #4 }
	}
	\renewcommand\do[1]{
		\IsClassSkill{##1}
	}\expandafter\dolistloop\csname#3ClassSkillsList\endcsname
}


%%%% Skills %%%%

% Add 3.5-only skills
\DeclareSkill[ArmorCheck]{Balance}{Dex}
\DeclareSkill{Concentration}{Con}
\DeclareSkill[Trained]{DecipherScript}{Int}
\DeclareSkill{Forgery}{Int}
\DeclareSkill{GatherInformation}{Cha}
\DeclareSkill[ArmorCheck]{Hide}{Dex}
\DeclareSkill[ArmorCheck]{Jump}{Str}
\DeclareSkill{Listen}{Wis}
\DeclareSkill[ArmorCheck] {MoveSilently}{Dex}
\DeclareSkill[Trained]{OpenLock}{Dex}
\DeclareSkill{Search}{Int}
\DeclareSkill[Trained]{SpeakLanguage}{Int}
\DeclareSkill{Spot}{Wis}
\DeclareSkill[Trained,ArmorCheck]{Tumble}{Dex}
\DeclareSkill{UseRope}{Dex}

\listinsert\ArmorCheckSkillsList{Swim} %Double swim Armor check penalty


%Command to add skill ranks
\newcommand\AddRanks[3][]{
	\ifthenelse{\equal#1{}}{
		\AddToCounter{Char#2RanksCount}{#3}
	}{
		\expandafter\let\expandafter\TmpClassSkillList\csname #1ClassSkillsList\endcsname
		\ifinlist{#2}{\TmpClassSkillList}
		{
			\AddToCounter{Char#2RanksCount}{#3}
		}{
			\AddToCounter{Char#2RanksCount}{#3 / 2}
		}
		\AddToCounter{Char#1SpareSkillRanksCount}{-1 * (#3)}
	}
}

%Commands to be run at sheet initialization
\newcommand{\AddIntToSkillRanks}{
	\ifthenelse{\value{AutoSkillRanks-Mode} = 1}{
		\SetCounter{@i}{1}
		\SetCounter{@j}{(\value{CharIntCount} - \value{CharIntEnhancementCount} - \value{CharIntTmpCount}) / 2 - 5}
		\renewcommand\do[1]{
			\SetCounter{@k}{\value{@j} + \value{##1SkillRanksPerLevelCount}}
			\ifthenelse{\value{@i} = 1}{
				\AddDebug{First Class is: ##1}
				\ifthenelse{\value{@k} < 1}{
					\AddDebug{Min 1 rank per level}
					\AddToCounter{Char##1SpareSkillRanksCount}{(1 - \value{##1SkillRanksPerLevelCount}) * (\value{Char##1ClassLevelCount} + 3)}
				}{
					\AddToCounter{Char##1SpareSkillRanksCount}{\value{@j} * (\value{Char##1ClassLevelCount} + 3)}
				}
			}{
				\AddDebug{Class \# \arabic{@i} is: ##1}
				\ifthenelse{\value{@k} < 1}{
					\AddDebug{Min 1 rank per level}
					\AddToCounter{Char##1SpareSkillRanksCount}{(1 - \value{##1SkillRanksPerLevelCount}) * \value{Char##1ClassLevelCount}}
				}{
					\AddToCounter{Char##1SpareSkillRanksCount}{\value{@j} * \value{Char##1ClassLevelCount}}
				}
			}
			\StepCounter{@i}
		}\dolistloop{\CharClassesList}
	}{}
}

\newcommand{\CalculateSynergyBonuses}{
	\ifthenelse{\value{CharBluffRanksCount} > 4}{
		\MiscBonus{Diplomacy}{2}
		\MiscBonus{Intimidate}{2}
		\MiscBonus{SleightOfHand}{2}
		\AddConditionalSkillMod{+2 to Disguise checks to act in character}
	}{}
	\ifthenelse{\value{CharCraftOneRanksCount} > 4}{
		\AddConditionalSkillMod{+2 to Appraise checks related to \csname CharCraftOnename\endcsname}}{}
	\ifthenelse{\value{CharCraftTwoRanksCount} > 4}{
		\AddConditionalSkillMod{+2 to Appraise checks related to \csname CharCraftTwoname\endcsname}}{}
	\ifthenelse{\value{CharCraftThreeRanksCount} > 4}{
		\AddConditionalSkillMod{+2 to Appraise checks related to \csname CharCraftThreename\endcsname}}{}
	\ifthenelse{\value{CharDecipherScriptRanksCount} > 4}{
		\ifthenelse{\value{CharSpellcraftRanksCount} > 4}{\AddConditionalSkillMod{+4 to Use Magic Device checks involving scrolls}}{\AddConditionalSkillMod{+2 to Use Magic Device checks involving scrolls}}}{}
	\ifthenelse{\value{CharEscapeArtistRanksCount} > 4}{
		\AddConditionalSkillMod{+2 to Use Rope checks involving bindings}}{}
	\ifthenelse{\value{CharHandleAnimalRanksCount} > 4}{
		\MiscBonus{Ride}{2}}{}
	\ifthenelse{\value{CharKnowledgeArcanaRanksCount} > 4}{
		\MiscBonus{Spellcraft}{2}}{}
	\ifthenelse{\value{CharKnowledgeEngineeringRanksCount} > 4}{
		\AddConditionalSkillMod{+2 to Search checks involving secret doors and similar compartments}}{}
	\ifthenelse{\value{CharKnowledgeDungeoneeringRanksCount} > 4}{
		\AddConditionalSkillMod{+2 to Survival checks when underground}}{}
	\ifthenelse{\value{CharKnowledgeGeographyRanksCount} > 4}{
		\AddConditionalSkillMod{+2 to Survival checks to keep from getting lost or for avoiding hazards}}{}
	\ifthenelse{\value{CharKnowledgeLocalRanksCount} > 4}{
		\MiscBonus{GatherInformation}{2}}{}
	\ifthenelse{\value{CharKnowledgeDungeoneeringRanksCount} > 4}{
		\AddConditionalSkillMod{+2 to Survival checks in aboveground natural environments}
	}{}
	\ifthenelse{\value{CharKnowledgeNobilityRanksCount} > 4}{
		\MiscBonus{Diplomacy}{2}}{}
	\ifthenelse{\value{CharKnowledgePlanesRanksCount} > 4}{
		\AddConditionalSkillMod{+2 to Survival checks when on other planes}}{}
	\ifthenelse{\value{CharSearchRanksCount} > 4}{
		\AddConditionalSkillMod{+2 to Survival checks to follow tracks}
	}{}
	\ifthenelse{\value{CharSenseMotiveRanksCount} > 4}{
		\MiscBonus{Diplomacy}{2}
	}{}
	\ifthenelse{\value{CharSpellcraftRanksCount} > 4}{
		\ifthenelse{\value{CharDecipherScriptRanksCount} > 4}{}{\AddConditionalSkillMod{+2 to Use Magic Device checks involving scrolls}}
	}{}
	\ifthenelse{\value{CharSurvivalRanksCount} > 4}{
		\MiscBonus{KnowledgeNature}{2}
	}{}
	\ifthenelse{\value{CharTumbleRanksCount} > 4}{
		\MiscBonus{Balance}{2}
	}{}
	\ifthenelse{\value{CharTumbleRanksCount} > 4}{
		\MiscBonus{Jump}{2}
	}{}
	\ifthenelse{\value{CharUseMagicDeviceRanksCount} > 4}{
		\AddConditionalSkillMod{+2 to Spellcraft checks to decipher scrolls}
	}{}
	\ifthenelse{\value{CharUseRopeRanksCount} > 4}{
		\AddConditionalSkillMod{+2 to Climb checks involving ropes}
		\AddConditionalSkillMod{+2 to Escape Artist checks involving ropes}
	}{}
}


%%%% Spells %%%%

\newcommand{\AddPrimarySpellcasting}[1]{
		\AddSpellSlots{0}{3}
		\AddSpellSlots{1}{1}
	\ifthenelse{#1 > 1}{
		\AddSpellSlots{0}{1}
		\AddSpellSlots{1}{1}
	\ifthenelse{#1 > 2}{
		\AddSpellSlots{2}{1}
	\ifthenelse{#1 > 3}{
		\AddSpellSlots{0}{1}
		\AddSpellSlots{1}{1}
		\AddSpellSlots{2}{1}
	\ifthenelse{#1 > 4}{
		\AddSpellSlots{3}{1}
	\ifthenelse{#1 > 5}{
		\AddSpellSlots{2}{1}
		\AddSpellSlots{3}{1}
	\ifthenelse{#1 > 6}{
		\AddSpellSlots{4}{1}
		\AddSpellSlots{0}{1}
		\AddSpellSlots{1}{1}
	\ifthenelse{#1 > 7}{
		\AddSpellSlots{3}{1}
		\AddSpellSlots{4}{1}
	\ifthenelse{#1 > 8}{
		\AddSpellSlots{5}{1}
		\AddSpellSlots{2}{1}
	\ifthenelse{#1 > 9}{
		\AddSpellSlots{4}{1}
		\AddSpellSlots{5}{1}
	\ifthenelse{#1 > 10}{
		\AddSpellSlots{6}{1}
		\AddSpellSlots{3}{1}
		\AddSpellSlots{1}{1}
	\ifthenelse{#1 > 11}{
		\AddSpellSlots{5}{1}
		\AddSpellSlots{6}{1}
	\ifthenelse{#1 > 12}{
		\AddSpellSlots{7}{1}
		\AddSpellSlots{4}{1}
		\AddSpellSlots{2}{1}
	\ifthenelse{#1 > 13}{
		\AddSpellSlots{6}{1}
		\AddSpellSlots{7}{1}
	\ifthenelse{#1 > 14}{
		\AddSpellSlots{8}{1}
		\AddSpellSlots{5}{1}
		\AddSpellSlots{3}{1}
	\ifthenelse{#1 > 15}{
		\AddSpellSlots{7}{1}
		\AddSpellSlots{8}{1}
	\ifthenelse{#1 > 16}{
		\AddSpellSlots{9}{1}
		\AddSpellSlots{6}{1}
		\AddSpellSlots{4}{1}
	\ifthenelse{#1 > 17}{
		\AddSpellSlots{8}{1}
		\AddSpellSlots{9}{1}
	\ifthenelse{#1 > 18}{
		\AddSpellSlots{7}{1}
		\AddSpellSlots{9}{1}
		\AddSpellSlots{5}{1}
	\ifthenelse{#1 > 19}{
		\AddSpellSlots{8}{1}
		\AddSpellSlots{9}{1}
	}{}}{}}{}}{}}{}}{}}{}}{}}{}}{}}{}}{}}{}}{}}{}}{}}{}}{}}{}
}
\newcommand{\AddSpontaneousPrimarySpellcasting}[1]{
		\AddSpellSlots{0}{5}
		\AddSpellSlots{1}{3}
	\ifthenelse{#1 > 1}{
		\AddSpellSlots{0}{1}
		\AddSpellSlots{1}{1}
	\ifthenelse{#1 > 2}{
		\AddSpellSlots{1}{1}
	\ifthenelse{#1 > 3}{
		\AddSpellSlots{1}{1}
		\AddSpellSlots{2}{3}
	\ifthenelse{#1 > 4}{
		\AddSpellSlots{2}{1}
	\ifthenelse{#1 > 5}{
		\AddSpellSlots{2}{1}
		\AddSpellSlots{3}{3}
	\ifthenelse{#1 > 6}{
		\AddSpellSlots{2}{1}
		\AddSpellSlots{3}{1}
	\ifthenelse{#1 > 7}{
		\AddSpellSlots{3}{1}
		\AddSpellSlots{4}{3}
	\ifthenelse{#1 > 8}{
		\AddSpellSlots{3}{1}
		\AddSpellSlots{4}{1}
	\ifthenelse{#1 > 9}{
		\AddSpellSlots{4}{1}
		\AddSpellSlots{5}{3}
	\ifthenelse{#1 > 10}{
		\AddSpellSlots{4}{1}
		\AddSpellSlots{5}{1}
	\ifthenelse{#1 > 11}{
		\AddSpellSlots{5}{1}
		\AddSpellSlots{6}{3}
	\ifthenelse{#1 > 12}{
		\AddSpellSlots{5}{1}
		\AddSpellSlots{6}{1}
	\ifthenelse{#1 > 13}{
		\AddSpellSlots{6}{1}
		\AddSpellSlots{7}{3}
	\ifthenelse{#1 > 14}{
		\AddSpellSlots{6}{1}
		\AddSpellSlots{7}{1}
	\ifthenelse{#1 > 15}{
		\AddSpellSlots{7}{1}
		\AddSpellSlots{8}{3}
	\ifthenelse{#1 > 16}{
		\AddSpellSlots{7}{1}
		\AddSpellSlots{8}{1}
	\ifthenelse{#1 > 17}{
		\AddSpellSlots{8}{1}
		\AddSpellSlots{9}{3}
	\ifthenelse{#1 > 18}{
		\AddSpellSlots{8}{1}
		\AddSpellSlots{9}{1}
	\ifthenelse{#1 > 19}{
		\AddSpellSlots{9}{2}
	}{}}{}}{}}{}}{}}{}}{}}{}}{}}{}}{}}{}}{}}{}}{}}{}}{}}{}}{}
	
}
\newcommand{\AddTwoThirdsSpellcasing}[1]{
		\AddSpellSlots{0}{2}
		\AddSpellsKnown{0}{4}
	\ifthenelse{#1 > 1}{
		\AddSpellSlots{0}{1}
		\AddSpellsKnown{0}{1}
		\AddSpellsKnown{1}{2}
	\ifthenelse{#1 > 2}{
		\AddSpellSlots{1}{1}
		\AddSpellsKnown{0}{1}
		\AddSpellsKnown{1}{1}
	\ifthenelse{#1 > 3}{
		\AddSpellSlots{1}{1}
		\AddSpellsKnown{2}{2}
	\ifthenelse{#1 > 4}{
		\AddSpellSlots{1}{1}
		\AddSpellSlots{2}{1}
		\AddSpellsKnown{1}{1}
		\AddSpellsKnown{2}{1}
	\ifthenelse{#1 > 5}{
		\AddSpellSlots{2}{1}
	\ifthenelse{#1 > 6}{
		\AddSpellsKnown{2}{1}
		\AddSpellsKnown{3}{2}
	\ifthenelse{#1 > 7}{
		\AddSpellSlots{2}{1}
		\AddSpellSlots{3}{1}
		\AddSpellsKnown{3}{1}
	\ifthenelse{#1 > 8}{
		\AddSpellSlots{3}{1}
	\ifthenelse{#1 > 9}{
		\AddSpellsKnown{3}{1}
		\AddSpellsKnown{4}{2}
	\ifthenelse{#1 > 10}{
		\AddSpellSlots{3}{1}
		\AddSpellSlots{4}{1}
		\AddSpellsKnown{4}{1}
	\ifthenelse{#1 > 11}{
		\AddSpellSlots{4}{1}
	\ifthenelse{#1 > 12}{
		\AddSpellsKnown{4}{1}
		\AddSpellsKnown{5}{2}
	\ifthenelse{#1 > 13}{
		\AddSpellSlots{0}{1}
		\AddSpellSlots{4}{1}
		\AddSpellSlots{5}{1}
		\AddSpellsKnown{5}{1}
	\ifthenelse{#1 > 14}{
		\AddSpellSlots{1}{1}
		\AddSpellSlots{5}{1}
	\ifthenelse{#1 > 15}{
		\AddSpellSlots{2}{1}
		\AddSpellsKnown{1}{1}
		\AddSpellsKnown{5}{1}
		\AddSpellsKnown{6}{2}
	\ifthenelse{#1 > 16}{
		\AddSpellSlots{3}{1}
		\AddSpellSlots{5}{1}
		\AddSpellSlots{6}{1}
		\AddSpellsKnown{2}{1}
		\AddSpellsKnown{6}{1}
	\ifthenelse{#1 > 17}{
		\AddSpellSlots{4}{1}
		\AddSpellSlots{6}{1}
		\AddSpellsKnown{3}{1}
	\ifthenelse{#1 > 18}{
		\AddSpellSlots{5}{1}
		\AddSpellSlots{6}{1}
		\AddSpellsKnown{4}{1}
		\AddSpellsKnown{6}{1}
	\ifthenelse{#1 > 19}{
		\AddSpellSlots{6}{1}
		\AddSpellsKnown{5}{1}
	}{}}{}}{}}{}}{}}{}}{}}{}}{}}{}}{}}{}}{}}{}}{}}{}}{}}{}}{}
}
\newcommand{\AddHalfSpellcasting}[1]{
	\ifthenelse{#1 > 5}{
		\AddSpellSlots{2}{1}
	\ifthenelse{#1 > 6}{
		\AddSpellsKnown{2}{1}
		\AddSpellsKnown{3}{2}
	\ifthenelse{#1 > 7}{
		\AddSpellSlots{2}{1}
		\AddSpellSlots{3}{1}
		\AddSpellsKnown{3}{1}
	\ifthenelse{#1 > 8}{
		\AddSpellSlots{3}{1}
	\ifthenelse{#1 > 9}{
		\AddSpellsKnown{3}{1}
		\AddSpellsKnown{4}{2}
	\ifthenelse{#1 > 10}{
		\AddSpellSlots{3}{1}
		\AddSpellSlots{4}{1}
		\AddSpellsKnown{4}{1}
	\ifthenelse{#1 > 11}{
		\AddSpellSlots{4}{1}
	\ifthenelse{#1 > 12}{
		\AddSpellsKnown{4}{1}
		\AddSpellsKnown{5}{2}
	\ifthenelse{#1 > 13}{
		\AddSpellSlots{0}{1}
		\AddSpellSlots{4}{1}
		\AddSpellSlots{5}{1}
		\AddSpellsKnown{5}{1}
	\ifthenelse{#1 > 14}{
		\AddSpellSlots{1}{1}
		\AddSpellSlots{5}{1}
	\ifthenelse{#1 > 15}{
		\AddSpellSlots{2}{1}
		\AddSpellsKnown{1}{1}
		\AddSpellsKnown{5}{1}
		\AddSpellsKnown{6}{2}
	\ifthenelse{#1 > 16}{
		\AddSpellSlots{3}{1}
		\AddSpellSlots{5}{1}
		\AddSpellSlots{6}{1}
		\AddSpellsKnown{2}{1}
		\AddSpellsKnown{6}{1}
	\ifthenelse{#1 > 17}{
		\AddSpellSlots{4}{1}
		\AddSpellSlots{6}{1}
		\AddSpellsKnown{3}{1}
	\ifthenelse{#1 > 18}{
		\AddSpellSlots{5}{1}
		\AddSpellSlots{6}{1}
		\AddSpellsKnown{4}{1}
		\AddSpellsKnown{6}{1}
	\ifthenelse{#1 > 19}{
		\AddSpellSlots{6}{1}
		\AddSpellsKnown{5}{1}
	}{}}{}}{}}{}}{}}{}}{}}{}}{}}{}}{}}{}}{}}{}}{}
}


%%%%Miscllany%%%%

%% Health Counter
\NewCounter{CharHPCount}
\NewCounter{CharHPRollsCount}
\newcommand{\HPRoll}[1]{
	\AddToCounter{CharHPCount}{#1}
	\AddToCounter{CharHPRollsCount}{1}
}

%% Miscellaneous Bonus
\newcommand{\MiscBonus}[3][]{
	\ifthenelse{\equal{#1}{}}{
		\AddToCounter{Char#2MiscCount}{#3}
	}{
		\IfCounter{Char#2#1ModCount}{
			\ifthenelse{\value{Char#2#1ModCount} < #3}{
				\AddToCounter{Char#2MiscCount}{#3 - \value{Char#2#1ModCount}}
				\SetCounter{Char#2#1ModCount}{#3}
			}{}
		}{
			\NewCounter{Char#2#1ModCount}
			\SetCounter{Char#2#1ModCount}{#3}
			\AddToCounter{Char#2MiscCount}{#3}
		}
	}
}
\newcommand{\TmpBonus}[3][]{
	\ifthenelse{\equal{#1}{}}{
		\AddToCounter{Char#2TmpCount}{#3}
	}{
		\IfCounter{Char#2#1ModCount}{
			\ifthenelse{\value{Char#2#1ModCount} < #3}{
				\AddToCounter{Char#2TmpCount}{#3 - \value{Char#2#1ModCount}}
				\SetCounter{Char#2#1ModCount}{#3}
			}{}
		}{
			\NewCounter{Char#2#1ModCount}
			\SetCounter{Char#2#1ModCount}{#3}
			\AddToCounter{Char#2TmpCount}{#3}
		}
	}
}
\newcommand{\EnhancementBonus}[2]{
	\SetCounter{@EnhancementBonusTempCounter}{#2}
	\ifthenelse{\value{@EnhancementBonusTempCounter} > \value{Char#1EnhancementCount}}{
		\SetCounter{Char#1EnhancementCount}{\value{@EnhancementBonusTempCounter}}
	}{}
}

%%Spell Resistance%%
\NewCounter{CharSpellResistanceCount}
\newcommand{\AddSpellResistance}[1]{
	\SetCounter{CharSpellResistanceCount}{\maxof{\value{CharSpellResistanceCount}}{#1}}
}

%%Initiative%%
\newcounter{CharInitiativeMiscCount}

%%Conditional Modifiers
\edef\ConditionalSkillsModList{}
\edef\ConditionalAttackModList{}
\edef\ConditionalDefModList{}
\newcommand{\AddConditionalSkillMod}[1]{
	\listadd\ConditionalSkillsModList{#1}}
\newcommand{\AddConditionalAttackMod}[1]{
	\listadd\ConditionalAttackModList{#1}}
\newcommand{\AddConditionalDefMod}[1]{
	\listadd\ConditionalDefModList{#1}}

%% Languages
\NewCounter{CharLanguagesCount}
\SetCounter{CharExpectedLanguagesCount}{0}
\edef\CharLanguagesList{}
\ProvideDocumentCommand{\AddCharLanguage}{s m}{
	\listinsert{\CharLanguagesList}{#2}
	\StepCounter{CharLanguagesCount}
	\IfBooleanT #1 {
		\StepCounter{CharExpectedLanguagesCount}
	}
}

%% XP
\newcounter{CharXPCount}
\newcounter{CharNextLevelXPCount}
\newcounter{XP-Mode}
\newcommand{\CalculateNextLevelXP}{
	\ifthenelse{\arabic{XP-Mode} = 0}{}{
		\ifthenelse{\arabic{XP-Mode} = 1}{
			\SetCounter{CharNextLevelXPCount}{0}
			\ifthenelse{\value{CharTotalLevelCount} > 0}{
				\ForLoop{@i}{0}{\value{@i}<\value{CharTotalLevelCount}}{
					\AddToCounter{CharNextLevelXPCount}{\value{@i} * 1000 + 1000}
				}
			}{}
		}{}
	}
}


%%%%Initialization%%%%

\newcommand{\Initialize}{
	\CalculateNextLevelXP
	\ComputeAbilityScores
	% add Con to HP
	\ifthenelse{\value{HP-Mode} > 0}{\AddToCounter{CharHPCount}{\value{CharConModCount} * \value{CharTotalLevelCount}}}{}
	% add feats from levels
	\AddToCounter{CharFeatsCount}{\value{CharTotalLevelCount} / 3 + 1}
	% add INT to Skill Ranks
	\AddIntToSkillRanks
	\SetCounter{CharIteratedAttacksCount}{(\value{CharBABCount}-1)/5+1}
	\InitializeSpellSlots
	\CalculateSynergyBonuses
	\CalculateLoads
	\CalculateWeights
	\CheckEncumberance
	\SpeedInitialize
	\SetCounter{CharDextoACCount}{\minof{\value{CharDexModCount}}{\value{CharMaxDexBonusCount}}}
	\RunChecks
}

\let\CountLanguagesMode\BooleanFalse
%%3.5 System Checks
\newcommand{\RunChecks}{
	\AddDebug{Running checks}
	\AddDebug{Checking HP Rolls}
	%CHECK HP ROLLS
	\ifthenelse{\value{HP-Mode} = 1}{ %Only run if we are in rolls mode for HP
		\AddDebug{HP Mode == 1. Checking that the number of HP rolls is correct:\\
			Number of HP rolls: \arabic{CharHPRollsCount}\\
			Level: \arabic{CharTotalLevelCount}}
		\ifthenelse{\arabic{CharHPRollsCount} < \arabic{CharTotalLevelCount}}{
			\AddDebug{Num HP rolls less than expected}
			\AddWarning{\DoMath{\value{CharTotalLevelCount} - \value{CharHPRollsCount}} HP rolls missing}
		}{
			\ifthenelse{\arabic{CharHPRollsCount} > \arabic{CharTotalLevelCount}}{
				\AddDebug{Num HP rolls more than expected}
				\AddWarning{\DoMath{\value{CharHPRollsCount} - \value{CharTotalLevelCount}} extra HP rolls}
			}{\AddDebug{Num HP rolls is correct}}
		}
	}{\AddDebug{HP Mode != 1. No need to check HP rolls}}
	%CHECK SKILL RANKS
	\ifthenelse{\value{AutoSkillRanks-Mode} = 1}{
		\AddDebug{Checking Skill Ranks}
		\AddDebug{Class List: \PrintList{\CharClassesList}}
		\renewcommand{\do}[1]{
			\AddDebug{Checking skill ranks for Class: ##1\\}
			\ifthenelse{\value{Char##1SpareSkillRanksCount} > 0}{
				\AddWarning{Class ##1 has \arabic{Char##1SpareSkillRanksCount} skill ranks left to spend}
			}{
				\ifthenelse{\value{Char##1SpareSkillRanksCount} < 0}{
					\AddWarning{Class ##1 has spent \DoMath{-\value{Char##1SpareSkillRanksCount}} too many skill ranks}
				}{}
			}
		}\dolistloop{\CharClassesList}
	}{}
	%CHECK FEATS
	\ifthenelse{\value{CountFeats-Mode} = 1}{
		\AddDebug{Checking Feats}
		\ifthenelse{\value{CharBonusFeatsCount} < 0}{
			\AddWarning{\DoMath{-\value{CharBonusFeatsCount}} too many bonus feats selected}
		}{
			\ifthenelse{\value{CharBonusFeatsCount} > 0}{
				\AddWarning{\arabic{CharBonusFeatsCount} bonus feats left to select}
			}{}}
		\ifthenelse{\value{CharFeatsCount} < 0}{
			\AddWarning{\DoMath{-\value{CharFeatsCount}} too many feats selected}
		}{
			\ifthenelse{\value{CharFeatsCount} > 0}{
				\AddWarning{\arabic{CharFeatsCount} feats left to select}
			}{}}
	}{}
	%CHECK LANGUAGES
	\IfBooleanT \CountLanguagesMode {
		\AddDebug{Checking Char Language Count}	

		\AddToCounter{CharExpectedLanguagesCount}{\value{CharSpeakLanguageRanksCount}}
		\ifthenelse{((\value{CharIntBaseCount} - 10) / 2) > -1}{
			\AddDebug{Expecting \arabic{CharExpectedLanguagesCount} languages from race, class, etc., plus \arabic{CharSpeakLanguageRanksCount} Speak Language ranks, plus \DoMath{(\value{CharIntBaseCount} - 10) / 2} from high INT}
			\AddToCounter{CharExpectedLanguagesCount}{(\value{CharIntBaseCount} - 10) / 2}
		}{
			\AddDebug{Expecting \arabic{CharExpectedLanguagesCount} languages from race, class, etc., plus \arabic{CharSpeakLanguageRanksCount} Speak Language ranks, plus 0 from negative INT mod}
		}
		\AddToCounter{CharExpectedLanguagesCount}{\value{CharSpeakLanguageRanksCount}}
		\ifthenelse{\value{CharExpectedLanguagesCount} > \value{CharLanguagesCount}}{
			\AddNotice{Pick \DoMath{\value{CharExpectedLanguagesCount} - \value{CharLanguagesCount}} more languages}
		}{
			\ifthenelse{\value{CharExpectedLanguagesCount} < \value{CharLanguagesCount}}{
				\AddNotice{Pick \DoMath{\value{CharLanguagesCount} - \value{CharExpectedLanguagesCount}} fewer languages}
			}{}
		}
	}
}
