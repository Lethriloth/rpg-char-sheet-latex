\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{WABH-houserules}[2019/03/28 Houserules for WABH2 campaign]


\NewCounter{CharClassBABCount}
\NewCounter{CharClassFortitudeCount}
\NewCounter{CharClassReflexCount}
\NewCounter{CharClassWillCount}

\RenewDocumentCommand{\ImportCharClass}{s O{} m m}{
	\input{\datafolder/Classes/#3.tex}
	\AddDebug{IMPORTCHARCLASS: add #4 Levels of #3}
	\ifthenelse{\equal{#2}{}}{
		\appto\CharLevel{\capitalize{#3} #4 }
	}{
		\appto\CharLevel{#2 #4 }
	}
	\listadd{\CharClassesList}{#3}
	\if\csname#3BAB\endcsname g
	\AddToCounter{CharClassBABCount}{#4 * 4}
	\fi
	\if\csname#3BAB\endcsname a
	\AddToCounter{CharClassBABCount}{#4 * 3}
	\fi
	\if\csname#3BAB\endcsname p
	\AddToCounter{CharClassBABCount}{#4 * 2 }
	\fi
	\if\csname#3Fort\endcsname g
	\AddToCounter{CharFortitudeCount}{2}
	\AddToCounter{CharClassFortitudeCount}{#4 * 3}
	\fi
	\if\csname#3Fort\endcsname p
	\AddToCounter{CharClassFortitudeCount}{#4 * 2}
	\fi
	\if\csname#3Ref\endcsname g
	\AddToCounter{CharReflexCount}{2}
	\AddToCounter{CharClassReflexCount}{#4 * 3}
	\fi
	\if\csname#3Ref\endcsname p
	\AddToCounter{CharClassReflexCount}{#4 * 2}
	\fi
	\if\csname#3Will\endcsname g
	\AddToCounter{CharWillCount}{2}
	\AddToCounter{CharClassWillCount}{#4 * 3}
	\fi
	\if\csname#3Will\endcsname p
	\AddToCounter{CharClassWillCount}{#4 * 2}
	\fi
	\NewCounter{Char#3ClassLevelCount}
	\SetCounter{Char#3ClassLevelCount}{#4}
	\NewCounter{Char#3SpareSkillRanksCount}
	\ifthenelse{\value{CharTotalLevelCount} = 0}{
		\SetCounter{Char#3SpareSkillRanksCount}{(\value{CharBonusSkillRanksPerLevelCount}+\value{#3SkillRanksPerLevelCount}) * (3 + #4)}
		\ifthenelse{\value{HP-Mode} = 1}{
			\AddToCounter{CharHPCount}{\value{#3HitDieSize}}
			\AddToCounter{CharHPRollsCount}{1}
		}{
			\ifthenelse{\value{HP-Mode} = 2}{
				\AddToCounter{CharHPCount}{\value{#3HitDieSize} + (\value{#3HitDieSize} + 1) * (#4 - 1) / 2}
			}
			{}
		}
	}{
		\SetCounter{Char#3SpareSkillRanksCount}{(\value{CharBonusSkillRanksPerLevelCount}+\value{#3SkillRanksPerLevelCount}) * #4}
		\ifthenelse{\value{HP-Mode} = 1}{
		}{
			\ifthenelse{\value{HP-Mode} = 2}{
				\AddToCounter{CharHPCount}{(\value{#3HitDieSize} + 1) * #4 / 2}
			}
			{}
		}
	}
	\AddToCounter{CharTotalLevelCount}{#4}
	\renewcommand\do[1]{
		\isClassSkill{##1}
	}\expandafter\dolistloop\csname#3ClassSkillsList\endcsname
	\IfBooleanTF #1 {} {\csname Add#3ClassFeatures\endcsname{#4}}
}

\NewDocumentCommand{\CalculateFractionalBABSaveBonuses}{}{
	\AddToCounter{CharBABCount}{\value{CharClassBABCount} / 4}
	\AddToCounter{CharFortitudeCount}{\value{CharClassFortitudeCount} / 6}
	\AddToCounter{CharReflexCount}{\value{CharClassReflexCount} / 6}
	\AddToCounter{CharWillCount}{\value{CharClassWillCount} / 6}
}

\preto{\Initialize}{
	\CalculateFractionalBABSaveBonuses
}

\NewDocumentCommand{\ImportCharCulture}{m}{
	\input{\datafolder/Cultures/#1.tex}
}


% Redefine Skills lists
\edef\KnowledgeSkillsList{}
\forcsvlist{\listadd\KnowledgeSkillsList}{KnowledgeArcana, KnowledgeDungeoneering, KnowledgeEngineering, KnowledgeFaerie, KnowledgeGeography, KnowledgeHistory, KnowledgeLocal, KnowledgeNature, KnowledgeNobility, KnowledgeReligion, KnowledgeShade}
\edef\SkillsList{}
\forcsvlist{\listadd\SkillsList}{Acrobatics, Appraise, Bluff, Climb, Concentration, CraftOne, CraftTwo, CraftThree, DecipherScript, Diplomacy, DisableDevice, Disguise, EscapeArtist, Fly, Forgery, GatherInformation, HandleAnimal, Heal, Intimidate, Jump, OpenLock, Perception, PerformOne, PerformTwo, PerformThree, ProfessionOne, ProfessionTwo, Ride, Search, SenseMotive, SleightOfHand, SpeakLanguage, Spellcraft, Stealth, Survival, Swim, UseMagicDevice, UseRope}
\forlistloop{\listadd\SkillsList}{\KnowledgeSkillsList}

\edef\ArmorCheckSkillsList{}
\forcsvlist{\listadd\ArmorCheckSkillsList}{Acrobatics, Climb, EscapeArtist, Fly, Jump, SleightOfHand, Stealth, Swim, Swim}

\renewcommand{\do}[1]{
	\NewCounter{Char#1Count}
	\NewCounter{Char#1ClassSkillBool}
	\NewCounter{Char#1RanksCount}
	\NewCounter{Char#1MiscCount}
}\dolistloop{\SkillsList}

% Redefine Synergy bonuses
\RenewDocumentCommand{\CalculateSynergyBonuses}{}{
	\ifthenelse{\value{CharAcrobaticsRanksCount} > 4}{
			\MiscBonus{Jump}{2}
	}
	\ifthenelse{\value{CharBluffRanksCount} > 4}{
		\MiscBonus{Diplomacy}{2}
		\MiscBonus{Intimidate}{2}
		\MiscBonus{SleightOfHand}{2}
		\AddConditionalSkillMod{+2 to Disguise checks to act in Character}
	}{}
	\ifthenelse{\value{CharCraftOneRanksCount} > 4}{
		\AddConditionalSkillMod{+2 to Appraise checks related to \csname CharCraftOnename\endcsname}}{}
	\ifthenelse{\value{CharCraftTwoRanksCount} > 4}{
		\AddConditionalSkillMod{+2 to Appraise checks related to \csname CharCraftTwoname\endcsname}}{}
	\ifthenelse{\value{CharCraftThreeRanksCount} > 4}{
		\AddConditionalSkillMod{+2 to Appraise checks related to \csname CharCraftThreename\endcsname}}{}
	\ifthenelse{\value{CharDecipherScriptRanksCount} > 4}{
		\ifthenelse{\value{CharSpellcraftRanksCount} > 4}{\AddConditionalSkillMod{+4 to Use Magic Device checks involving scrolls}}{\AddConditionalSkillMod{+2 to Use Magic Device checks involving scrolls}}}{}
	\ifthenelse{\value{CharEscapeArtistRanksCount} > 4}{
		\AddConditionalSkillMod{+2 to Use Rope checks involving bindings}
	}{}
	\ifthenelse{\value{CharHandleAnimalRanksCount} > 4}{
		\MiscBonus{Ride}{2}
	}{}
	\ifthenelse{\value{CharJumpRanksCount} > 4}{
		\AddConditionalSkillMod{+2 to Acrobatics checks to tumble}	
	}{}
	\ifthenelse{\value{CharKnowledgeArcanaRanksCount} > 4}{
		\MiscBonus{Spellcraft}{2}
	}{}
	\ifthenelse{\value{CharKnowledgeEngineeringRanksCount} > 4}{
		\AddConditionalSkillMod{+2 to Search checks involving secret doors and similar compartments}
	}{}
	\ifthenelse{\value{CharKnowledgeDungeoneeringRanksCount} > 4}{
		\AddConditionalSkillMod{+2 to Survival checks when underground}
	}{}
	\ifthenelse{\value{CharKnowledgeGeographyRanksCount} > 4}{
		\AddConditionalSkillMod{+2 to Survival checks to keep from getting lost or for avoiding hazards}
	}{}
	\ifthenelse{\value{CharKnowledgeLocalRanksCount} > 4}{
		\MiscBonus{GatherInformation}{2}
	}{}
	\ifthenelse{\value{CharKnowledgeDungeoneeringRanksCount} > 4}{
		\AddConditionalSkillMod{+2 to Survival checks in aboveground natural environments}
	}{}
	\ifthenelse{\value{CharKnowledgeFaerieRanksCount} > 4}{
		\AddConditionalSkillMod{+2 to Survival checks when in Faerie}
	}{}
	\ifthenelse{\value{CharKnowledgeShadeRanksCount} > 4}{
	\AddConditionalSkillMod{+2 to Survival checks when in the Shade}
	}{}
	\ifthenelse{\value{CharSearchRanksCount} > 4}{
		\AddConditionalSkillMod{+2 to Survival checks to follow tracks}
	}{}
	\ifthenelse{\value{CharSenseMotiveRanksCount} > 4}{
		\MiscBonus{Diplomacy}{2}
	}{}
	\ifthenelse{\value{CharSpellcraftRanksCount} > 4}{
		\ifthenelse{\value{CharDecipherScriptRanksCount} > 4}{}{\AddConditionalSkillMod{+2 to Use Magic Device checks involving scrolls}}
	}{}
	\ifthenelse{\value{CharSurvivalRanksCount} > 4}{
		\MiscBonus{KnowledgeNature}{2}
	}{}
	\ifthenelse{\value{CharUseMagicDeviceRanksCount} > 4}{
		\AddConditionalSkillMod{+2 to Spellcraft checks to decipher scrolls}
	}{}
	\ifthenelse{\value{CharUseRopeRanksCount} > 4}{
		\AddConditionalSkillMod{+2 to Climb checks involving ropes}
		\AddConditionalSkillMod{+2 to Escape Artist checks involving ropes}
	}{}
}

%% Adds shield hardness and HP for shield blocks
\NewCounter{CharShieldHardnessCount}
\SetCounter{CharShieldHPCount}{0}
\RenewDocumentCommand{\AddShield}{m m o m m m m m O{}}{%{Name}{Shield Bonus}[Max Dex]{Armor Check Penalty}{Spell Failure}{Hardness}{HP}{Weight}[Notes]
	\renewcommand{\CharShieldName}{#1}
	\AddShieldBonus{#2}
	\IfNoValueF{#3}{
		\SetCounter{CharMaxDexShieldCount}{#3}
		\ifthenelse{#3 < \value{CharMaxDexBonusCount}}{
			\SetCounter{CharMaxDexBonusCount}{#3}
		}{}
	}
	\SetCounter{CharShieldArmorCheckPenaltyCount}{#4}
	\renewcommand{\do}[1]{
		\MiscBonus{##1}{#4}
	}\dolistloop{\ArmorCheckSkillsList}
	\SetCounter{CharShieldSpellFailureCount}{#5}
	\AddToCounter{TotalACItemsSpellFailure}{#5}
	\SetCounter{CharShieldHardnessCount}{#6}
	\SetCounter{CharShieldHPCount}{#7}
	\AddGearItem{Shield}{#8}
	\renewcommand{\CharShieldNotes}{#9}
}


%%Renames Currencies
\let\AddSkulls\AddPlatinum
\let\StoreSkulls\StorePlatinum
\let\AddCrowns\AddGold
\let\StoreCrowns\StoreGold
\let\AddCoin\AddSilver
\let\StoreCoin\StoreSilver
\let\AddBits\AddCopper
\let\StoreBits\StoreCopper