\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{WABH-houserules}[2019/03/28 Houserules for WABH2 campaign]


\NewCounter{charClassBABCount}
\NewCounter{charClassFortitudeCount}
\NewCounter{charClassReflexCount}
\NewCounter{charClassWillCount}

\RenewDocumentCommand{\ImportCharClass}{s O{} m m}{
	\input{\datafolder/Classes/#3.tex}
	\AddDebug{IMPORTCHARCLASS: add #4 Levels of #3}
	\ifthenelse{\equal{#2}{}}{
		\appto\charLevel{\capitalize{#3} #4 }
	}{
		\appto\charLevel{#2 #4 }
	}
	\listadd{\charClassesList}{#3}
	\if\csname#3BAB\endcsname g
	\Addtocounter{charClassBABCount}{#4 * 4}
	\fi
	\if\csname#3BAB\endcsname a
	\AddToCounter{charClassBABCount}{#4 * 3}
	\fi
	\if\csname#3BAB\endcsname p
	\AddToCounter{charClassBABCount}{#4 * 2 }
	\fi
	\if\csname#3Fort\endcsname g
	\AddToCounter{charFortitudeCount}{2}
	\AddToCounter{charClassFortitudeCount}{#4 * 3}
	\fi
	\if\csname#3Fort\endcsname p
	\AddToCounter{charClassFortitudeCount}{#4 * 2}
	\fi
	\if\csname#3Ref\endcsname g
	\AddToCounter{charReflexCount}{2}
	\AddToCounter{charClassReflexCount}{#4 * 3}
	\fi
	\if\csname#3Ref\endcsname p
	\AddToCounter{charClassReflexCount}{#4 * 2}
	\fi
	\if\csname#3Will\endcsname g
	\AddToCounter{charWillCount}{2}
	\AddToCounter{charClassWillCount}{#4 * 3}
	\fi
	\if\csname#3Will\endcsname p
	\AddToCounter{charClassWillCount}{#4 * 2}
	\fi
	\NewCounter{char#3ClassLevelCount}
	\SetCounter{char#3ClassLevelCount}{#4}
	\newcounter{char#3SpareSkillRanksCount}
	\ifthenelse{\value{charTotalLevelCount} = 0}{
		\SetCounter{char#3SpareSkillRanksCount}{(\value{charBonusSkillRanksPerLevelCount}+\value{#3SkillRanksPerLevelCount}) * (3 + #4)}
		\ifthenelse{\value{HP-Mode} = 1}{
			\AddToCounter{charHPCount}{\value{#3HitDieSize}}
			\AddToCounter{charHPRollsCount}{1}
		}{
			\ifthenelse{\value{HP-Mode} = 2}{
				\AddToCounter{charHPCount}{\value{#3HitDieSize} + (\value{#3HitDieSize} + 1) * (#4 - 1) / 2}
			}
			{}
		}
	}{
		\SetCounter{char#3SpareSkillRanksCount}{(\value{charBonusSkillRanksPerLevelCount}+\value{#3SkillRanksPerLevelCount}) * #4}
		\ifthenelse{\value{HP-Mode} = 1}{
		}{
			\ifthenelse{\value{HP-Mode} = 2}{
				\AddToCounter{charHPCount}{(\value{#3HitDieSize} + 1) * #4 / 2}
			}
			{}
		}
	}
	\AddToCounter{charTotalLevelCount}{#4}
	\renewcommand\do[1]{
		\isClassSkill{##1}
	}\expandafter\dolistloop\csname#3ClassSkillsList\endcsname
	\IfBooleanTF #1 {} {\csname add#3ClassFeatures\endcsname{#4}}
}

\NewDocumentCommand{\CalculateFractionalBABSaveBonuses}{}{
	\AddToCounter{charBABCount}{\value{charClassBABCount} / 4}
	\AddToCounter{charFortitudeCount}{\value{charClassFortitudeCount} / 6}
	\AddToCounter{charReflexCount}{\value{charClassReflexCount} / 6}
	\AddToCounter{charWillCount}{\value{charClassWillCount} / 6}
}

\preto{\Initialize}{
	\CalculateFractionalBABSaveBonuses
}

\NewDocumentCommand{\ImportCharCulture}{m}{
	\input{\datafolder/Cultures/#1.tex}
}


% Redefine Skills lists
\edef\KnowledgeSkillsList{}
\forcsvlist{\listadd\KnowledgeSkillsList}{KnowledgeArcana, KnowledgeDungeoneering, KnowledgeEngineering, KnowledgeGeography, KnowledgeHistory, KnowledgeLocal, KnowledgeNature, KnowledgeNobility, KnowledgePlanes, KnowledgeReligion}
\edef\SkillsList{}
\forcsvlist{\listadd\SkillsList}{Acrobatics, Appraise, Bluff, Climb, Concentration, CraftOne, CraftTwo, CraftThree, DecipherScript, Diplomacy, DisableDevice, Disguise, EscapeArtist, Fly, Forgery, GatherInformation, HandleAnimal, Heal, Intimidate, Jump, OpenLock, Perception, PerformOne, PerformTwo, PerformThree, ProfessionOne, ProfessionTwo, Ride, Search, SenseMotive, SleightOfHand, SpeakLanguage, Spellcraft, Stealth, Survival, Swim, UseMagicDevice, UseRope}
\forlistloop{\listadd\SkillsList}{\KnowledgeSkillsList}

\edef\ArmorCheckSkillsList{}
\forcsvlist{\listadd\ArmorCheckSkillsList}{Acrobatics, Climb, EscapeArtist, Fly, Jump, SleightOfHand, Stealth, Swim, Swim}

\renewcommand{\do}[1]{
	\NewCounter{char#1Count}
	\NewCounter{char#1ClassSkillBool}
	\NewCounter{char#1RanksCount}
	\NewCounter{char#1MiscCount}
}\dolistloop{\SkillsList}

% Redefine Synergy bonuses
\RenewDocumentCommand{\CalculateSynergyBonuses}{}{
	\ifthenelse{\value{charAcrobaticsRanksCount} > 4}{
			\MiscBonus{Jump}{2}
	}
	\ifthenelse{\value{charBluffRanksCount} > 4}{
		\MiscBonus{Diplomacy}{2}
		\MiscBonus{Intimidate}{2}
		\MiscBonus{SleightOfHand}{2}
		\AddConditionalSkillMod{+2 to Disguise checks to act in character}
	}{}
	\ifthenelse{\value{charCraftOneRanksCount} > 4}{
		\AddConditionalSkillMod{+2 to Appraise checks related to \csname charCraftOnename\endcsname}}{}
	\ifthenelse{\value{charCraftTwoRanksCount} > 4}{
		\AddConditionalSkillMod{+2 to Appraise checks related to \csname charCraftTwoname\endcsname}}{}
	\ifthenelse{\value{charCraftThreeRanksCount} > 4}{
		\AddConditionalSkillMod{+2 to Appraise checks related to \csname charCraftThreename\endcsname}}{}
	\ifthenelse{\value{charDecipherScriptRanksCount} > 4}{
		\ifthenelse{\value{charSpellcraftRanksCount} > 4}{\AddConditionalSkillMod{+4 to Use Magic Device checks involving scrolls}}{\AddConditionalSkillMod{+2 to Use Magic Device checks involving scrolls}}}{}
	\ifthenelse{\value{charEscapeArtistRanksCount} > 4}{
		\AddConditionalSkillMod{+2 to Use Rope checks involving bindings}
	}{}
	\ifthenelse{\value{charHandleAnimalRanksCount} > 4}{
		\MiscBonus{Ride}{2}
	}{}
	\ifthenelse{\value{charJumpRanksCount} > 4}{
		\AddConditionalSkillMod{+2 to Acrobatics checks to tumble}	
	}{}
	\ifthenelse{\value{charKnowledgeArcanaRanksCount} > 4}{
		\MiscBonus{Spellcraft}{2}
	}{}
	\ifthenelse{\value{charKnowledgeEngineeringRanksCount} > 4}{
		\AddConditionalSkillMod{+2 to Search checks involving secret doors and similar compartments}
	}{}
	\ifthenelse{\value{charKnowledgeDungeoneeringRanksCount} > 4}{
		\AddConditionalSkillMod{+2 to Survival checks when underground}}{}
	\ifthenelse{\value{charKnowledgeGeographyRanksCount} > 4}{
		\AddConditionalSkillMod{+2 to Survival checks to keep from getting lost or for avoiding hazards}}{}
	\ifthenelse{\value{charKnowledgeLocalRanksCount} > 4}{
		\MiscBonus{GatherInformation}{2}}{}
	\ifthenelse{\value{charKnowledgeDungeoneeringRanksCount} > 4}{
		\AddConditionalSkillMod{+2 to Survival checks in aboveground natural environments}}{}
	\ifthenelse{\value{charKnowledgePlanesRanksCount} > 4}{
		\AddConditionalSkillMod{+2 to Survival checks when on other planes}}{}
	\ifthenelse{\value{charSearchRanksCount} > 4}{
		\AddConditionalSkillMod{+2 to Survival checks to follow tracks}
	}{}
	\ifthenelse{\value{charSenseMotiveRanksCount} > 4}{
		\MiscBonus{Diplomacy}{2}
	}{}
	\ifthenelse{\value{charSpellcraftRanksCount} > 4}{
		\ifthenelse{\value{charDecipherScriptRanksCount} > 4}{}{\AddConditionalSkillMod{+2 to Use Magic Device checks involving scrolls}}
	}{}
	\ifthenelse{\value{charSurvivalRanksCount} > 4}{
		\MiscBonus{KnowledgeNature}{2}
	}{}
	\ifthenelse{\value{charUseMagicDeviceRanksCount} > 4}{
		\AddConditionalSkillMod{+2 to Spellcraft checks to decipher scrolls}
	}{}
	\ifthenelse{\value{charUseRopeRanksCount} > 4}{
		\AddConditionalSkillMod{+2 to Climb checks involving ropes}
		\AddConditionalSkillMod{+2 to Escape Artist checks involving ropes}
	}{}
}
